{"version":3,"mappings":"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","names":["firebaseConfig","missing","v","k","msg","app","getApps","getApp","initializeApp","db","getFirestore","auth","getAuth","waitForAuthReady","timeoutMs","resolve","off","onAuthStateChanged","ensureAnonLogin","setPersistence","browserLocalPersistence","inMemoryPersistence","e2","ready","signInAnonymously","MAX_CHARS","MAX_LINES","md","MarkdownIt","mdLoaders","__vitePreload","topics","ref","selectedId","selectedHtml","loadTopics","items","path","loader","raw","first","l","id","a","b","watch","t","x","newMessage","messages","charCount","computed","lineCount","isCharOver","isLineOver","col","collection","me","onMounted","user","u","q","query","orderBy","onSnapshot","snap","d","data","dt","showFatal","e","pre","createApp","App","err"],"ignoreList":[],"sources":["../../src/lib/firebase.js","../../src/App.vue","../../src/main.js"],"sourcesContent":["// src/lib/firebase.js\r\nimport { initializeApp, getApps, getApp } from 'firebase/app'\r\nimport { getFirestore, serverTimestamp as ts } from 'firebase/firestore'\r\nimport {\r\n  getAuth,\r\n  setPersistence,\r\n  browserLocalPersistence,\r\n  inMemoryPersistence,\r\n  signInAnonymously,\r\n  onAuthStateChanged,\r\n} from 'firebase/auth'\r\n\r\n// ==========================================================\r\n// Firebase 設定\r\n// ==========================================================\r\nconst firebaseConfig = {\r\n  apiKey:      import.meta.env.VITE_FB_API_KEY,\r\n  authDomain:  import.meta.env.VITE_FB_AUTH_DOMAIN,\r\n  projectId:   import.meta.env.VITE_FB_PROJECT_ID,\r\n  appId:       import.meta.env.VITE_FB_APP_ID,\r\n}\r\n\r\n// 欠落チェック\r\nconst missing = Object.entries(firebaseConfig)\r\n  .filter(([, v]) => !v)\r\n  .map(([k]) => k)\r\n\r\nif (missing.length) {\r\n  const msg = `[firebaseConfig] missing keys: ${missing.join(', ')}`\r\n  if (import.meta.env.DEV) {\r\n    throw new Error(msg) // 開発時は強制エラー\r\n  } else {\r\n    console.error(msg)   // 本番は画面を止めない\r\n  }\r\n}\r\n\r\n// ==========================================================\r\n// Firebase 初期化（HMR / 多重初期化対策）\r\n// ==========================================================\r\nconst app = getApps().length ? getApp() : initializeApp(firebaseConfig)\r\nexport const db = getFirestore(app)\r\nexport const auth = getAuth(app)\r\nexport { ts }\r\n\r\n// ==========================================================\r\n// 匿名ログインを安全に確立\r\n// ==========================================================\r\nasync function waitForAuthReady(timeoutMs = 1500) {\r\n  if (auth.currentUser !== null) return auth.currentUser\r\n  await new Promise((resolve) => {\r\n    const off = onAuthStateChanged(auth, () => { off(); resolve() })\r\n    setTimeout(() => {\r\n      try { off() } catch {}\r\n      resolve()\r\n    }, timeoutMs)\r\n  })\r\n  return auth.currentUser\r\n}\r\n\r\nexport async function ensureAnonLogin() {\r\n  // 永続化（localStorage優先 → ダメなら inMemory）\r\n  try {\r\n    await setPersistence(auth, browserLocalPersistence)\r\n  } catch (e) {\r\n    console.warn('[auth] localPersistence NG → inMemory', e?.code || e)\r\n    try {\r\n      await setPersistence(auth, inMemoryPersistence)\r\n    } catch (e2) {\r\n      console.error('[auth] setPersistence failed', e2?.code || e2)\r\n    }\r\n  }\r\n\r\n  const ready = await waitForAuthReady()\r\n  if (ready) return ready\r\n\r\n  // オフラインならサインインを諦める\r\n  if (typeof navigator !== 'undefined' && navigator.onLine === false) {\r\n    console.warn('[auth] offline, skip signInAnonymously')\r\n    return null\r\n  }\r\n\r\n  try {\r\n    const cred = await signInAnonymously(auth)\r\n    return cred.user\r\n  } catch (e) {\r\n    if (e?.code === 'auth/network-request-failed') {\r\n      console.warn('[auth] network-request-failed, continue without auth')\r\n      return null\r\n    }\r\n    console.error('[auth] anonymous sign-in failed', e?.code, e?.message || e)\r\n    return null\r\n  }\r\n}\r\n","<script setup>\nimport { ref, computed, onMounted, watch } from 'vue'\nimport MarkdownIt from 'markdown-it'\nimport { db, ensureAnonLogin, ts, auth } from './lib/firebase'\nimport { collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDocs } from 'firebase/firestore'\nimport { onAuthStateChanged } from 'firebase/auth'\n\nconst md = new MarkdownIt({ breaks: true })\n\n/* =============== 左サイド：Markdown ロード & 本文 =============== */\n// Vite 5 以降は as:'raw' じゃなく query:'?raw' を推奨\nconst mdLoaders = import.meta.glob('./content/*.md', { query: '?raw' })\n\nconst topics = ref([])          // [{id,title,raw}]\nconst selectedId = ref(null)    // 現在選択中の id\nconst selectedHtml = ref('')    // 表示用 HTML\n\nasync function loadTopics() {\n  const items = []\n  for (const [path, loader] of Object.entries(mdLoaders)) {\n    const raw = await loader()\n    // 最初の非空行をタイトルに（先頭の # を剥がす）\n    const first = (raw.split(/\\r?\\n/).find(l => l.trim()) || '').replace(/^#\\s*/, '')\n    const id = path.split('/').pop().replace(/\\.md$/, '')\n    items.push({ id, title: first || id, raw })\n  }\n  // 01_ 02_… 前提で安定ソート\n  items.sort((a, b) => a.id.localeCompare(b.id, 'ja'))\n  topics.value = items\n  if (!selectedId.value && items.length) selectedId.value = items[0].id\n}\n\nwatch(selectedId, () => {\n  const t = topics.value.find(x => x.id === selectedId.value)\n  selectedHtml.value = t ? md.render(t.raw) : ''\n})\n\n/* =============== 右：メンバー投稿（Firestore共有） =============== */\nconst MAX_CHARS = 500\nconst MAX_LINES = 10\n\nconst nameInput = ref('')\nconst newMessage = ref('')\nconst messages = ref([])\n\nconst charCount = computed(() => newMessage.value.length)\nconst lineCount = computed(() => newMessage.value ? newMessage.value.split(/\\r\\n|\\r|\\n/).length : 0)\nconst isCharOver = computed(() => charCount.value > MAX_CHARS)\nconst isLineOver = computed(() => lineCount.value > MAX_LINES)\nconst canSubmit = computed(() => !!newMessage.value.trim() && !isCharOver.value && !isLineOver.value)\n\nconst col = collection(db, 'messages')\n\n// 🔰 ここが超重要：reactive なログイン情報\nconst me = ref(null)\n\nonMounted(async () => {\n  console.log('[mounted] start')\n\n  // --- 左：Markdown 読み込み\n  await loadTopics()\n\n  // ① 匿名ログインを“必ず”確立（失敗しても null 返るだけで画面は動く設計）\n  const user = await ensureAnonLogin()\n  me.value = user\n  console.log('[ensureAnonLogin] uid =', me.value?.uid)\n\n  // ② 状態変化も拾う（保険）\n  onAuthStateChanged(auth, (u) => {\n    me.value = u\n    console.log('[onAuthStateChanged] uid =', u?.uid)\n  })\n\n  // ③ デバッグ用\n  window._auth = auth\n  window._me = me\n  window._topics = topics\n\n  // ④ 投稿の購読\n  const q = query(col, orderBy('created_at', 'desc'))\n  onSnapshot(q, (snap) => {\n    messages.value = snap.docs.map(d => {\n      const data = d.data()\n      const dt = data.created_at?.toDate ? data.created_at.toDate() : new Date()\n      return {\n        id: d.id,\n        name: data.name || '名無し',\n        text: data.text || '',\n        at: dt.toLocaleString(),\n        uid: data.uid ?? null,\n      }\n    })\n    console.log('[onSnapshot] first=', messages.value[0])\n  })\n\n  console.log('[mounted] done')\n})\n\nfunction handleSubmit(){\n  const t = newMessage.value.trim()\n  const nm = nameInput.value.trim() || '名無し'\n  if(!canSubmit.value) return\n  addDoc(col, {\n    name: nm,\n    text: t,\n    created_at: ts(),\n    uid: me.value?.uid ?? null,\n  }).then(() => {\n    newMessage.value = ''\n    console.log('[addDoc] ok, uid=', me.value?.uid)\n  }).catch(e => {\n    console.error('[addDoc] error', e)\n  })\n}\n\nasync function removeOne(id){\n  try {\n    console.log('[delete] try id=', id)\n    await deleteDoc(doc(db, 'messages', id))\n    console.log('[delete] ok id=', id)\n  } catch (e) {\n    console.error('[delete] error', e)\n    alert('削除に失敗したかも。コンソールを確認してね。')\n  }\n}\n\nasync function clearAll(){\n  if(!confirm('全投稿を削除しますか？')) return\n  const snap = await getDocs(col)\n  for (const d of snap.docs) await deleteDoc(d.ref)\n}\n</script>\n","// src/main.js\nimport { createApp } from 'vue'\nimport App from './App.vue'\n\nfunction showFatal(e){\n  const pre = document.createElement('pre')\n  pre.style.cssText='white-space:pre-wrap;padding:16px;background:#fff;color:#c00;border:1px solid #f99;font-family:monospace'\n  pre.textContent='起動時エラー:\\n'+(e?.stack||e)\n  document.body.innerHTML=''; document.body.appendChild(pre)\n}\ntry{\n  const app = createApp(App)\n  app.config.errorHandler = (err)=>showFatal(err)\n  window.addEventListener('error', e=>showFatal(e.error||e.message))\n  window.addEventListener('unhandledrejection', e=>showFatal(e.reason))\n  app.mount('#app')\n}catch(e){ showFatal(e) }\n"],"file":"assets/index-Bp2njihR.js"}